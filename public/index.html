<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Aetherius Headless Console</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 980px; }
      input, button, textarea { font: inherit; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 12px 0; }
      textarea { width: 100%; min-height: 120px; }
      pre { background: #0b1020; color: #e6edf3; padding: 12px; border-radius: 10px; overflow: auto; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Aetherius Headless Console</h1>
    <p class="muted">Vercel API + 브라우저 로그인/토큰 인증</p>

    <div class="card">
      <h2>1) 로그인</h2>
      <div class="row">
        <label>Username <input id="username" value="admin" /></label>
        <label>Password <input id="password" type="password" /></label>
        <button id="loginBtn">Login</button>
        <button id="logoutBtn">Logout</button>
      </div>
      <p class="muted">토큰은 브라우저 localStorage에 저장됩니다.</p>
    </div>

    <div class="card">
      <h2>2) Tick</h2>
      <div class="row">
        <label>Count <input id="tickCount" value="1" /></label>
        <button id="tickBtn">POST /api/tick</button>
      </div>
    </div>

    <div class="card">
      <h2>3) Command</h2>
      <div class="row">
        <label>cmd <input id="cmd" style="min-width: 520px" value="status" /></label>
        <button id="cmdBtn">POST /api/command</button>
      </div>
    </div>

    <div class="card">
      <h2>Output</h2>
      <pre id="out">(empty)</pre>
    </div>

    <script type="module">
      const out = document.getElementById('out');
      const tokenKey = 'aetherius_token';
      const rolesKey = 'aetherius_roles';

      function setOut(obj) {
        out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
      }

      function getToken() {
        return localStorage.getItem(tokenKey);
      }

      function setRoles(roles) {
        if (Array.isArray(roles)) {
          localStorage.setItem(rolesKey, JSON.stringify(roles));
        }
      }

      function getRoles() {
        const raw = localStorage.getItem(rolesKey);
        if (!raw) return [];
        try {
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      async function api(path, method, body) {
        const headers = { 'Content-Type': 'application/json' };
        const token = getToken();
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
        const data = await res.json().catch(() => ({}));
        return { status: res.status, data };
      }

      document.getElementById('loginBtn').addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const r = await api('/api/login', 'POST', { username, password });
        if (r.data && r.data.token) {
          localStorage.setItem(tokenKey, r.data.token);
          if (r.data.roles) setRoles(r.data.roles);
        }
        setOut(r);
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem(tokenKey);
        localStorage.removeItem(rolesKey);
        setOut({ ok: true, message: 'logged out' });
      });

      document.getElementById('tickBtn').addEventListener('click', async () => {
        const count = Number(document.getElementById('tickCount').value || '1');
        const r = await api('/api/tick', 'POST', { count });
        setOut(r);
      });

      document.getElementById('cmdBtn').addEventListener('click', async () => {
        const cmd = document.getElementById('cmd').value;
        const r = await api('/api/command', 'POST', { cmd });
        setOut(r);
      });
    </script>
  </body>
</html>
